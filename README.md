# Overview
A runnable sample app of Subscriptions based on [Shopify developer document](https://shopify.dev/docs/apps/selling-strategies/subscriptions/modeling)

This app is cloned and modified from [this sample](../../../shopify-barebone-app-sample).

# How to run
0. Follow [this sample](../../../shopify-barebone-app-sample)'s [How to run] steps.

1. Add the following environmental variables set in the step 0 above.
```
    SHOPIFY_CONTRACT_EXT_ID:      The value of 'SHOPIFY_MY_THEME_CONTRACT_EXT_ID' in '.env' which is generated by `shopify app deploy` in the step 0 above
```

2. Replace the following value in the toml file set in the step 0 above. 
    - _scopes in [access_scopes]_ = "write_products,write_orders,read_customer_payment_methods,write_own_subscription_contracts,write_customers,write_assigned_fulfillment_orders,write_merchant_managed_fulfillment_orders,write_third_party_fulfillment_orders"
    - _subpath in [app_proxy]_ = "mysubpage"

3. Run `npm run build` and `shopify app deploy` again.

4. **Submit subscription API access request** from your app settings in [partner dashboard](https://partners.shopify.com/).

# How to install
Follow the [this sample](../../../shopify-barebone-app-sample)'s [How to install] steps.

# How to update
Follow the [this sample](../../../shopify-barebone-app-sample)'s [How to update] steps. Note that if you update `YOUR_APP_URL`, you need to change the code modified in the step 4 above.

# Sample list

All sample videos are available at [Wiki](../../wiki).

# Trouble shooting
- If you cannot see any selling plans in your product pages in the storefront through the theme app extension in your dev. store, **try to activate Shopify Payments test mode or PayPal live mode** because Shopify purchase options (subscription / deferred purchase) limit the available payment methods (even if you activate PayPal, you can use Boogus gateway for test credit card payment, tho...).

# TIPS
- [subscriptionBillingAttemptCreate](https://shopify.dev/docs/api/admin-graphql/unstable/mutations/subscriptionBillingAttemptCreate) is **NOT** guaranteed to has the latest order in its response due to some time lag, and the best way of order fullfillment and billing error hanlding is querying the contract later in a batch process (this sample uses a few second blocking as a synced wait which should not be applied to our live code...). For the app responsibility, check [this page](https://shopify.dev/docs/apps/selling-strategies/subscriptions/modeling#division-of-responsibilities-between-shopify-and-apps).
- You can use the endpoint of `webhookgdpr` for [GDPR Webhooks](https://shopify.dev/docs/apps/store/security/gdpr-webhooks).
- If you fail to get [protected customer data](https://shopify.dev/docs/apps/store/data-protection/protected-customer-data) in [subscriptionContract query](https://shopify.dev/docs/api/admin-graphql/unstable/queries/subscriptionContract), apply the customer data request from your app settings in partner dashboard and submit your app first (the submission can be in-review, doesn't have to be completed for dev. store testing) which enable you get them. 
- [Deferred purchase options](https://shopify.dev/docs/apps/selling-strategies/purchase-options/deferred) (Pre-order / TBYB = Try-before-you-buy) uses the similar APIs, and if you are interested in, check [this sample](../../../shopify-deferred-purchase-sample-app), too.


# Disclaimer

- This code is fully _unofficial_ and NOT guaranteed to pass [the public app review](https://shopify.dev/apps/store/review) for Shopify app store. The official requirements are described [here](https://shopify.dev/apps/store/requirements). 
- You need to follow [Shopi API Licene and Terms of Use](https://www.shopify.com/legal/api-terms) even for custom app usage.
- If you use this code for your production, **all resposibilties are owned by you**.
